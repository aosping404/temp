name: CI / Build / Package

on:
  push:
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
        - os: windows-latest
          host: windows
          arch: win64_msvc2022_64
        - os: macos-latest
          host: mac
          arch: clang_64
        - os: ubuntu-latest
          host: linux
          arch: gcc_64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Qt (Windows)
      uses: jurplel/install-qt-action@v4
      if: matrix.host == 'windows'
      with:
        version: '6.8.3'
        host: windows
        target: desktop
        arch: win64_msvc2022_64
        cache: true

    - name: Install Qt (macOS)
      uses: jurplel/install-qt-action@v4
      if: matrix.host == 'mac'
      with:
        version: '6.8.3'
        host: mac
        target: desktop
        arch: clang_64
        cache: true

    - name: Install Qt (Linux)
      uses: jurplel/install-qt-action@v4
      if: matrix.host == 'linux'
      with:
        version: '6.8.3'
        host: linux
        target: desktop
        cache: true

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1.14
      with:
        cmake-version: '3.27'

    - name: Configure CMake
      run: |
        cmake -B build -S . -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cmake --build build --config Release

    - name: Find Executable
      id: find_exe
      shell: bash
      run: |
        if [ "${{ matrix.host }}" == "windows" ]; then
          echo "Searching for Windows executable..."
          echo "Build directory contents:"
          ls -la build/ 2>/dev/null || echo "build/ not found"
          ls -la build/Release/ 2>/dev/null || echo "build/Release/ not found"
          ls -la build/bin/ 2>/dev/null || echo "build/bin/ not found"
          
          # 使用 find 搜索所有可能的 temp.exe
          found_exe=""
          if command -v find &> /dev/null; then
            found_exe=$(find build -name "temp.exe" -type f 2>/dev/null | head -1)
          fi
          
          if [ -n "$found_exe" ]; then
            echo "Found executable via find: $found_exe"
            echo "exe_path=$found_exe" >> $GITHUB_OUTPUT
            echo "exe_dir=$(dirname $found_exe)" >> $GITHUB_OUTPUT
          else
            echo "Checking common locations..."
            if [ -f "build/Release/temp.exe" ]; then
              echo "Found at: build/Release/temp.exe"
              echo "exe_path=build/Release/temp.exe" >> $GITHUB_OUTPUT
              echo "exe_dir=build/Release" >> $GITHUB_OUTPUT
            elif [ -f "build/bin/Release/temp.exe" ]; then
              echo "Found at: build/bin/Release/temp.exe"
              echo "exe_path=build/bin/Release/temp.exe" >> $GITHUB_OUTPUT
              echo "exe_dir=build/bin/Release" >> $GITHUB_OUTPUT
            elif [ -f "build/bin/temp.exe" ]; then
              echo "Found at: build/bin/temp.exe"
              echo "exe_path=build/bin/temp.exe" >> $GITHUB_OUTPUT
              echo "exe_dir=build/bin" >> $GITHUB_OUTPUT
            else
              echo "ERROR: Executable not found in any expected location"
            fi
          fi
        elif [ "${{ matrix.host }}" == "mac" ]; then
          if [ -d "build/bin/temp.app" ]; then
            echo "exe_path=build/bin/temp.app" >> $GITHUB_OUTPUT
            echo "exe_dir=build/bin" >> $GITHUB_OUTPUT
          elif [ -f "build/bin/temp" ]; then
            echo "exe_path=build/bin/temp" >> $GITHUB_OUTPUT
            echo "exe_dir=build/bin" >> $GITHUB_OUTPUT
          fi
        else
          if [ -f "build/bin/temp" ]; then
            echo "exe_path=build/bin/temp" >> $GITHUB_OUTPUT
            echo "exe_dir=build/bin" >> $GITHUB_OUTPUT
          fi
        fi

    - name: Package (Windows)
      if: matrix.host == 'windows'
      shell: pwsh
      run: |
        Write-Host "Debug: Searching for executable..."
        Write-Host "exe_path output: ${{ steps.find_exe.outputs.exe_path }}"
        Write-Host "exe_dir output: ${{ steps.find_exe.outputs.exe_dir }}"
        
        # 尝试多个可能的位置
        $possiblePaths = @(
          "build\Release\temp.exe",
          "build\bin\Release\temp.exe",
          "build\bin\temp.exe",
          "build\temp.exe"
        )
        
        $exePath = ""
        $exeDir = ""
        
        foreach ($path in $possiblePaths) {
          if (Test-Path $path) {
            $exePath = $path
            $exeDir = Split-Path -Parent $path
            Write-Host "Found executable at: $exePath"
            break
          }
        }
        
        # 如果还没找到，使用步骤输出
        if (-not $exePath) {
          $exePath = "${{ steps.find_exe.outputs.exe_path }}"
          $exeDir = "${{ steps.find_exe.outputs.exe_dir }}"
        }
        
        if ($exePath -and (Test-Path $exePath)) {
          windeployqt --release --compiler-runtime $exePath
          $packageDir = "package"
          New-Item -ItemType Directory -Force -Path $packageDir | Out-Null
          Copy-Item -Path $exeDir\* -Destination $packageDir -Recurse -Force
          $runScriptContent = "@echo off`r`ncd /d `"%~dp0`"`r`nstart `"`" `"temp.exe`""
          [System.IO.File]::WriteAllText("$packageDir\运行程序.bat", $runScriptContent, [System.Text.Encoding]::UTF8)
          
          Write-Host "Package created in: $packageDir"
        } else {
          Write-Host "Error: Executable not found"
          exit 1
        }

    - name: Package (macOS)
      if: matrix.host == 'mac'
      shell: bash
      run: |
        exe_path="${{ steps.find_exe.outputs.exe_path }}"
        exe_dir="${{ steps.find_exe.outputs.exe_dir }}"
        if [ -n "$exe_path" ] && [ -e "$exe_path" ]; then
          if [[ "$exe_path" == *.app ]]; then
            macdeployqt "$exe_path" -always-overwrite
            package_dir="package"
            mkdir -p "$package_dir"
            cp -R "$exe_path" "$package_dir/"
          else
            app_name="temp.app"
            app_path="package/$app_name"
            mkdir -p "$app_path/Contents/MacOS"
            mkdir -p "$app_path/Contents/Frameworks"
            mkdir -p "$app_path/Contents/Resources"
            
            cp "$exe_path" "$app_path/Contents/MacOS/temp"
            chmod +x "$app_path/Contents/MacOS/temp"
            printf '<?xml version="1.0" encoding="UTF-8"?>\n<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">\n<plist version="1.0">\n<dict>\n  <key>CFBundleExecutable</key>\n  <string>temp</string>\n  <key>CFBundleIdentifier</key>\n  <string>com.example.temp</string>\n  <key>CFBundleName</key>\n  <string>temp</string>\n  <key>CFBundlePackageType</key>\n  <string>APPL</string>\n  <key>CFBundleVersion</key>\n  <string>1.0</string>\n</dict>\n</plist>\n' > "$app_path/Contents/Info.plist"
            macdeployqt "$app_path" -always-overwrite
          fi
          printf '#!/bin/bash\ncd "$(dirname "$0")"\nopen "temp.app"\n' > "package/运行程序.sh"
          chmod +x "package/运行程序.sh"
          
          echo "Package created in: package/"
        else
          echo "Error: Executable not found"
          exit 1
        fi

    - name: Install Linux Deployment Tools
      if: matrix.host == 'linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y patchelf

    - name: Package (Linux)
      if: matrix.host == 'linux'
      shell: bash
      run: |
        exe_path="${{ steps.find_exe.outputs.exe_path }}"
        exe_dir="${{ steps.find_exe.outputs.exe_dir }}"
        if [ -n "$exe_path" ] && [ -e "$exe_path" ]; then
          echo "Packaging Linux application: $exe_path"
          
          package_dir="package"
          mkdir -p "$package_dir"
          cp "$exe_path" "$package_dir/temp"
          chmod +x "$package_dir/temp"
          qt_prefix="${{ env.Qt6_DIR }}"
          if [ -z "$qt_prefix" ] || [ ! -d "$qt_prefix" ]; then
            if command -v qmake6 &> /dev/null; then
              qt_prefix=$(qmake6 -query QT_INSTALL_PREFIX)
            elif command -v qmake &> /dev/null; then
              qt_prefix=$(qmake -query QT_INSTALL_PREFIX)
            fi
          fi
          
          if [ -n "$qt_prefix" ] && [ -d "$qt_prefix" ]; then
            echo "Qt prefix found: $qt_prefix"
            
            lib_dir="$package_dir/lib"
            plugins_dir="$package_dir/plugins"
            mkdir -p "$lib_dir" "$plugins_dir"
            ldd "$package_dir/temp" | grep -i qt | while read line; do
              lib_file=$(echo "$line" | awk '{print $3}')
              if [ -n "$lib_file" ] && [ -f "$lib_file" ]; then
                cp "$lib_file" "$lib_dir/"
                if [ -L "$lib_file" ]; then
                  real_file=$(readlink -f "$lib_file")
                  if [ -f "$real_file" ]; then
                    cp "$real_file" "$lib_dir/"
                  fi
                fi
              fi
            done
            qt_plugins="$qt_prefix/plugins"
            if [ -d "$qt_plugins/platforms" ]; then
              cp -r "$qt_plugins/platforms" "$plugins_dir/"
            fi
            for plugin_dir in imageformats iconengines platformthemes; do
              if [ -d "$qt_plugins/$plugin_dir" ]; then
                cp -r "$qt_plugins/$plugin_dir" "$plugins_dir/" 2>/dev/null || true
              fi
            done
            if command -v patchelf &> /dev/null; then
              patchelf --set-rpath '$ORIGIN/lib' "$package_dir/temp" 2>/dev/null || true
            fi
            printf '#!/bin/bash\nSCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"\ncd "$SCRIPT_DIR"\nexport LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$LD_LIBRARY_PATH"\nexport QT_PLUGIN_PATH="$SCRIPT_DIR/plugins"\n./temp "$@"\n' > "$package_dir/运行程序.sh"
            chmod +x "$package_dir/运行程序.sh"
          else
            printf '#!/bin/bash\nSCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"\ncd "$SCRIPT_DIR"\n./temp "$@"\n' > "$package_dir/运行程序.sh"
            chmod +x "$package_dir/运行程序.sh"
          fi
          
          echo "Package created in: $package_dir/"
        else
          echo "Error: Executable not found"
          exit 1
        fi

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: temp-${{ matrix.os }}-${{ github.run_number }}
        path: |
          package/**
        if-no-files-found: warn
        retention-days: 30

  release:
    name: Create Release
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Extract version from tag
      id: tag_version
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
        VERSION=${TAG_NAME#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag_version.outputs.tag_name }}
        name: Release ${{ steps.tag_version.outputs.version }}
        body: |
          ## Release ${{ steps.tag_version.outputs.version }}
          
          ### 下载
          
          - **Windows**: 下载 `temp-windows-latest-*.zip`，解压后运行 `运行程序.bat` 或直接运行 `temp.exe`
          - **macOS**: 下载 `temp-macos-latest-*.zip`，解压后运行 `运行程序.sh` 或双击 `temp.app`
          - **Linux**: 下载 `temp-ubuntu-latest-*.zip`，解压后运行 `./运行程序.sh` 或直接运行 `./temp`
          
          ### 系统要求
          
          - Windows: Windows 10 或更高版本
          - macOS: macOS 10.13 或更高版本
          - Linux: Ubuntu 20.04+ / Debian 11+ / Fedora 34+ 等
          
          **注意**: 所有依赖已包含在包中，无需安装 Qt 或其他依赖。
        files: |
          artifacts/**/*
        draft: false
        prerelease: false
